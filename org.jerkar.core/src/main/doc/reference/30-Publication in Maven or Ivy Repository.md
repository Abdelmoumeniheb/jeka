## Publication on binary repositories
----

Jerkar is able to publish on both Maven and Ivy repository. This includes repositories as [Sonatype Nexus](http://www.sonatype.org/nexus/) or [Jfrog Artifactory](http://www.jfrog.com/artifactory/).

Maven and Ivy have different publication model, so Jerkar proposes specific APIs according you want to publish on a Maven or Ivy repository. 

### Publish to a Maven repository

Jerkar proposes a complete API to pubish on Maven repository. POM files will be generated by Jerkar according 
elements provided by users.

#### Using raw API

You can set minimal information in order to deploy a file on a Maven repository as below :

```
File fileToPublish = new File("build/output/myFile.jar");
JkPublishRepo repo = JkRepo.maven("http://my.mvn.repo/publisher").asPublishRepo()
JkVersionedModule versionedModule = JkVersionedModule.of("myGroup:myName", "0.2.1");
JkPublisher.of(repo).publishMaven(versionedModule, JkMavenPublication.of(fileToPublish), JkDependencies.on());
```

You can also set additional information in order to :

- Publish more than one artifact.
- Produce & publish checksum files for each published artifact.
- Mention if you wish or not to use unique snapshot ([What is it ?](http://stackoverflow.com/questions/1243574/how-to-stop-maven-artifactory-from-keeping-snapshots-with-timestamps)).
- Feed generated pom with data necessary to publish on [central repository](https://maven.apache.org/guides/mini/guide-central-repository-upload.html).
- Sign published artifact with PGP

<p class="alert alert-success">
Not that for signing with PGP, you don't need to have PGP installed on Jerkar machine. Jerkar uses <a href="https://www.bouncycastle.org/">Bouncy Castle</a> internally to sign artifacts.
</p>

```
// You can sign your artifatcs with PGP
JkPgp pgp = JkPgp.ofSecretRing(new File("/usr/myName/pgp/privateRing"), "myPgpPhrase");

JkPublishRepo repo = JkRepo.maven(publishRepo)
JkPublishRepo repo = JkRepo.maven(publishRepo)
    .withCredential("myRepoUserName", "myRepoPassword").asPublishRepo()
    .withUniqueSnapshot(false)
    .withSigner(pgp)
    .andSha1Md5Checksums(); // You can checksum each of published artifacts
			
JkVersionedModule versionedModule = JkVersionedModule.of("myGroup:myName", "0.2.1");
		
// Optinal : if you need to add metadata in the generated pom
JkMavenPublicationInfo info = JkMavenPublicationInfo
    .of("my project", "my description", "http://myproject.github")
    .withScm("http://scm/url/connection")
    .andApache2License()
    .andGitHubDeveloper("myName", "myName@provider.com");				
		
// Optional : if you want publish sources
File srcZip = ouputDir("src.zip");
JkZipper.of(this.src).to(srcZip);
		
JkMavenPublication publication = JkMavenPublication.of(jarFile).with(info).and(srcZip, "sources");
JkPublisher.of(repo).publishMaven(versionedModule, publication, JkDependencies.on());
```

#### Using JkJavaBuild template

When using this template, the effort you must produce to publish artifacts is minimal or zero if you don't need special feature.
The prerequisite is to setup _options.properties_ according to your infrastructure.

##### Using defaults

If you don't specify anything the publication will occurs locally at : _[JERKAR USER HOME]/maven-publish-dir_

If you specify only credential as

```
repo.publish.username=myUsername
repo.publish.password=myPassword
```

Jerkar will use OSSRH public repository : https://oss.sonatype.org/content/repositories/snapshots for snapshots 
and https://oss.sonatype.org/content/repositories/releases for releases. 
For more precision about default see [`JkDependencySupport#publishRepositories`](https://github.com/jerkar/jerkar/blob/master/org.jerkar.core/src/main/java/org/jerkar/tool/JkBuildDependencySupport.java) method.


##### Using explicit settings

You can set explicit settings at [JERKAR USER DIR]/options.properties level, so every build will leverage from these settings

```
repo.publish.url=https://my.nexus/snaphots
repo.publish.username=myNexusSnapshotUserName
repo.publish.password=myNexusSnapshotPassword
repo.release.url=https://my.nexus/releases
repo.release.username=myNexusReleaseUserName
repo.release.password=myNexusReleasePassword
```
In this case the snapshot artifacts (those with version's ending with '-SNAPSHOT') will be published on https://my.nexus/snaphots repository while the other will be published in https://my.nexus/releases.

If you mention only 

```
repo.publish.url=https://my.nexus/all
repo.publish.username=myNexusSnapshotUserName
repo.publish.password=myNexusSnapshotPassword
```
then everything will be published to https://my.nexus/all.

You can also override `publishRepositories``in your build script so you can write your own specific logic to setup and select publish repositories. 

```
@Override  
protected JkPublishRepos publishRepositories() {
    return JkPublishRepos.ossrh(JkOptions.get("ossrh.username"),
	    JkOptions.get("ossrh.password"), pgp());
}
```

### Publish to a Ivy repository

Publishing to an Ivy repository is similar to publishing to a Maven one, except :

- The publishing creates a _ivy.xml_ file instead of a _pom.xml_ file.
- The publisher needs to declare at least one Ivy repository. If not the case, nothing will be published.
- You must feed the publish method with `JkIvyPublication` instead of `JkMavenPublication`.

This give an example of build file publishing on ivy with specific scope mapping.

```
public class IvyPublishBuild extends JkJavaBuild {
	
    {
        this.pack.tests = true;
        this.pack.javadoc = true;
    }
	
    @Override
    public JkModuleId moduleId() {
        return JkModuleId.of("org.jerkar", "script-samples-ivy");
    }

    @Override
    public JkDependencies dependencies() {
        return JkDependencies.builder()
            .on(GUAVA, "18.0")	
            .on(JERSEY_SERVER, "1.19").mapScope(RUNTIME, TEST).to(COMPILE)
            .on("com.orientechnologies:orientdb-client:2.0.8")
            .on(JUNIT, "4.11").scope(TEST)
            .on(MOCKITO_ALL, "1.9.5").scope(TEST)
            .build();
    }
	
    @Override
    protected JkRepos downloadRepositories() {
        return JkRepo.ivy(this.repo.publish.url).and(JkRepo.mavenCentral());
    }
	
    @Override 
    protected JkPublishRepos publishRepositories() {
        return JkRepo.ivy(this.repo.publish.url).asPublishRepos();
    }
	
    @Override
    protected JkIvyPublication ivyPublication() {
        return JkIvyPublication.of(packer().jarFile(), COMPILE)
            .and(packer().jarTestFile(), TEST)
            .and(packer().javadocFile(), JAVADOC)
            .and(packer().jarSourceFile(), "src", SOURCES)
            .and(packer().jarTestSourceFile(), "src", SOURCES, TEST);	
    }

}
```
