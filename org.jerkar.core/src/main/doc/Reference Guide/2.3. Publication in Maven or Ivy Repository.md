## Publication on binary repositories (Out Dated)
----

Jerkar is able to publish on both Maven and Ivy repository. This includes repositories as [Sonatype Nexus](http://www.sonatype.org/nexus/) or [Jfrog Artifactory](http://www.jfrog.com/artifactory/).

Maven and Ivy have different publication model, so Jerkar proposes specific APIs according you want to publish on a Maven or Ivy repository. 

### Publish to a Maven repository

Jerkar proposes a complete API to pubish on Maven repository. POM files will be generated by Jerkar according 
elements provided by users.

#### Using raw API

You can set minimal information in order to deploy a file on a Maven repository as below :

```
File fileToPublish = new File("build/output/myFile.jar");
JkPublishRepo repo = JkRepo.maven("http://my.mvn.repo/publisher").asPublishRepo()
JkVersionedModule versionedModule = JkVersionedModule.of("myGroup:myName", "0.2.1");
JkPublisher.of(repo).publishMaven(versionedModule, JkMavenPublication.of(fileToPublish), JkDependencies.on());
```

You can also set additional information in order to :

- Publish more than one artifact.
- Produce & publish checksum files for each published artifact.
- Mention if you wish or not to use unique snapshot ([What is it ?](http://stackoverflow.com/questions/1243574/how-to-stop-maven-artifactory-from-keeping-snapshots-with-timestamps)).
- Feed generated pom with data necessary to publish on [central repository](https://maven.apache.org/guides/mini/guide-central-repository-upload.html).
- Sign published artifact with PGP

<p class="alert alert-success">
Not that for signing with PGP, you don't need to have PGP installed on Jerkar machine. Jerkar uses <a href="https://www.bouncycastle.org/">Bouncy Castle</a> internally to sign artifacts.
</p>

```
// You can sign your artifatcs with PGP
JkPgp pgp = JkPgp.ofSecretRing(new File("/usr/myName/pgp/privateRing"), "myPgpPhrase");

JkPublishRepo repo = JkRepo.maven(publishRepo)
JkPublishRepo repo = JkRepo.maven(publishRepo)
    .withCredential("myRepoUserName", "myRepoPassword").asPublishRepo()
    .withUniqueSnapshot(false)
    .withSigner(pgp)
    .andSha1Md5Checksums(); // You can checksum each of published artifacts
			
JkVersionedModule versionedModule = JkVersionedModule.of("myGroup:myName", "0.2.1");
		
// Optinal : if you need to add metadata in the generated pom
JkMavenPublicationInfo info = JkMavenPublicationInfo
    .of("my project", "my description", "http://myproject.github")
    .withScm("http://scm/url/connection")
    .andApache2License()
    .andGitHubDeveloper("myName", "myName@provider.com");				
		
// Optional : if you want publish sources
File srcZip = ouputDir("src.zip");
JkZipper.of(this.src).to(srcZip);
		
JkMavenPublication publication = JkMavenPublication.of(jarFile).with(info).and(srcZip, "sources");
JkPublisher.of(repo).publishMaven(versionedModule, publication, JkDependencies.on());
```

#### Using JkJavaBuild template

If your build class inherit from _JkBuildJava_ template, the effort you must produce to publish artifacts is minimal or zero if you don't need special feature.
The prerequisite is to setup _options.properties_ according to your infrastructure.

##### Using defaults

If you don't specify anything the publication will occurs locally at : _[JERKAR USER HOME]/maven-publish-dir_

If you specify 

```
repo.publish.url=http://my.repository/location
repo.publish.username=myUsername (optional)
repo.publish.password=myPassword (optional)
```

Jerkar will use this repository to publish your all your artifacts (snapshots and releases).

If you specify 

```
repo.publish.url=http://my.repository/location
repo.publish.username=myUsername (optional)
repo.publish.password=myPassword (optional)

repo.publishRelease.url=http://my.repository/release/location
repo.publishRelease.username=myUsername (optional)
repo.publishRelease.password=myPassword (optional)
```

Jerkar will publish snapshots on _http://my.repository/location_ and releases on _http://my.repository/release/location_.


##### Using a pool of repositories

You can define a pool of repositories in your options ([JERKAR USER DIR]/options.properties) so that 
you can refer only to the repository name to point on a repository.

```
repo.myRepo1.url=https://my.nexus/repo1

repo.myRepo2.url=https://my.nexus/repo2
repo.myRepo2.username=usernameRepo2
repo.myRepo2.password=repo2

repo.myRepo3.url=https://my.nexus/repo3
repo.myRepo3.username=usernameRepo3
repo.myRepo3.password=passwordRepo3
```

Then you can mention your publish repositories in option as

```
repo.publishName=myRepo2   (for snapshots + releases)
```
or

```
repo.publishName=myRepo2   (for snapshots)
repo.publishReleaseName=myRepo3  (for releases)
```

or you can override the JKbuildDependencySupport#publishRepositories in your build class as

```
@Override
protected JkPublishRepos publishRepositories() {
    return repoFromOptions("myRepo2").asPublishSnapshotRepo()
        .andRelease(repoFromOptions("myRepo3"));
}
```

In this case the snapshot artifacts (those with version's ending with '-SNAPSHOT') will be published on https://my.nexus/repo2 while the other will be published in https://my.nexus/repo3.

You can also override `publishRepositories``in your build script so you can write your own specific logic to setup and select publish repositories. 


### Publish to a Ivy repository

Publishing to an Ivy repository is similar to publishing to a Maven one, except :

- The publishing creates a _ivy.xml_ file instead of a _pom.xml_ file.
- The publisher needs to declare at least one Ivy repository. If not the case, nothing will be published.
- You must feed the publish method with `JkIvyPublication` instead of `JkMavenPublication`.

This give an example of build file publishing on ivy with specific scope mapping.

```
public class IvyPublishBuild extends JkJavaBuild {
	
    {
        this.pack.tests = true;
        this.pack.javadoc = true;
    }
	
    @Override
    public JkModuleId moduleId() {
        return JkModuleId.of("org.jerkar", "script-samples-ivy");
    }

    @Override
    public JkDependencies dependencies() {
        return JkDependencies.builder()
            .on(GUAVA, "18.0")	
            .on(JERSEY_SERVER, "1.19").mapScope(RUNTIME, TEST).to(COMPILE)
            .on("com.orientechnologies:orientdb-client:2.0.8")
            .on(JUNIT, "4.11").scope(TEST)
            .on(MOCKITO_ALL, "1.9.5").scope(TEST)
            .build();
    }
	
    @Override
    protected JkRepos downloadRepositories() {
        return JkRepo.ivy(this.repo.publish.url).and(JkRepo.mavenCentral());
    }
	
    @Override 
    protected JkPublishRepos publishRepositories() {
        return JkRepo.ivy(this.repo.publish.url).asPublishRepos();
    }
	
    @Override
    protected JkIvyPublication ivyPublication() {
        return JkIvyPublication.of(packer().jarFile(), COMPILE)
            .and(packer().jarTestFile(), TEST)
            .and(packer().javadocFile(), JAVADOC)
            .and(packer().jarSourceFile(), "src", SOURCES)
            .and(packer().jarTestSourceFile(), "src", SOURCES, TEST);	
    }

}
```

### Publish to a public central repositoty

Publishing to a central repository (as Maven central through OSSRH) generally requires extra information to be passed along indications to sign your artifacts.

```
    // Extra information mandatory to publish to OSSRH 
    @Override
    protected JkMavenPublication mavenPublication() {
        return super.mavenPublication().with(
                JkMavenPublicationInfo
                .of("Jerkar", "Build simpler, stronger, faster", "http://jerkar.github.io")
                .withScm("https://github.com/jerkar/jerkar.git").andApache2License()
                .andGitHubDeveloper("djeang", "djeangdev@yahoo.fr"));
    }

   @Override
   protected JkPublishRepos publishRepositories() {
        return JkPublishRepos.ossrh("myOssrhUserName", "myOssrhPassword", pgp());
   }
```

OSSRH requires to sign artifact using PGP. For such Jerkar needs a _JkPgp_ object containing everything necessary to sign artifact. 
By default Jerkar assumes that :

- public ring is located at _[USER HOME]\AppData\Roaming\gnupg\pubring.gpg_ on Windows and at _[USER HOME]/gnupg/pubring.gpg_ on Unix systems
- secret ring is located at [USER HOME]\AppData\Roaming\gnupg\secring.gpg on Windows and at _[USER HOME]/gnupg/secring.gpg_ on Unix systems
- secret ring password is provided by option _pgp.secretKeyPassword_
 
Pass your secret key password as an option _pgp.secretKeyPassword=mySecretRingPassword_ when you launch your build or store it in your [JERKAR USER HOME]/options.properties if you consider it is safe enough.

